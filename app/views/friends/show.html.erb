<div class="profile-header">
  <h1 class="profile-name"><%= @user.name %></h1>
  <div style="display: flex; align-items: center; gap: 1rem;">
    <p class="profile-username" style="margin: 0;">@<%= @user.username %></p>
    <div id="follow-btn-<%= @user.id %>">
      <% if current_user.id != @user.id %>
        <% if current_user.following?(@user) %>
          <%= button_to "Following", unfollow_friend_path(@user), method: :delete, class: "btn btn-outline-secondary btn-lg", title: "Unfollow", form: { style: "display: inline-block; margin: 0;" } %>
        <% else %>
          <%= button_to "Follow", follow_friend_path(@user), method: :post, class: "btn btn-primary btn-lg", title: "Follow", form: { style: "display: inline-block; margin: 0;" } %>
        <% end %>
      <% end %>
    </div>
  </div>
  
  <% if @user.lastfm_connected %>
    <div style="margin: 1rem 0;">
      <p style="color: #d51007;">♫ Last.fm Connected</p>
    </div>
  <% end %>
  
  <div class="profile-stats-grid">
    <div class="stat-card">
        <div class="stat-value"><%= @user.reviews.count %></div>
        <div class="stat-label">Reviews</div>
      </div>
      <div class="stat-card">
        <div class="stat-value"><%= link_to @user.followers.count, followers_friend_path(@user) %></div>
        <div class="stat-label">Followers</div>
      </div>
      <div class="stat-card">
        <div class="stat-value"><%= link_to @user.following.count, following_friend_path(@user) %></div>
        <div class="stat-label">Following</div>
      </div>
      <div class="stat-card">
      <div class="stat-value"><%= @user.reviews.average(:rating)&.round(1) || 0 %></div>
      <div class="stat-label">Avg Rating</div>
    </div>
  </div>
</div>
<h2>Recent Reviews</h2>

<% if @reviews.any? %>
  <% @reviews.joins(:song).order(Arel.sql("songs.title ASC, songs.artist ASC, COALESCE(songs.album, '') ASC")).each do |review| %>
    <div class="review" style="display: flex; gap: 1rem; align-items: flex-start;">
      <div style="flex: 1;">
        <div class="review-header">
          <span class="review-user">
            <%= link_to review.song.title, song_path(review.song) %> — <%= review.song.artist %> <%= review.song.album.present? ? "— #{review.song.album}" : '' %>
          </span>
          <span class="review-rating"><%= review.rating %></span>
        </div>
        <p class="review-comment"><%= review.comment %></p>
      </div>
    </div>
  <% end %>
<% else %>
  <div class="empty-state">
    <p>No reviews yet</p>
    <p class="text-muted"><%= @user.name %> hasn't reviewed any songs yet.</p>
  </div>
<% end %>
