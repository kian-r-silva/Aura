<div class="container mt-5">
  <div class="row mb-4">
    <div class="col-md-8">
      <h1>Find Friends</h1>
      <p class="text-muted">Search for other music lovers and follow them to see their reviews.</p>
    </div>
  </div>

  <div class="row mb-6">
    <div class="col-md-6">
      <%= form_with url: friends_path, method: :get, style: "background: transparent; padding: 0; border: none; box-shadow: none; margin: 0; max-width: none;", local: true do |f| %>
        <div style="display: flex; gap: 10px; align-items: center;">
          <%= f.text_field :q, placeholder: "Search by username or name...", value: @query, class: "form-control" %>
          <%= f.submit "Search", class: "btn btn-primary", style: "flex-shrink: 0;" %>
        </div>
      <% end %>
    </div>
  </div>

  <% if @friends.any? %>
    <div style="display: inline-flex; flex-wrap: wrap; gap: 24px;">
      <% @friends.each do |friend| %>
        <div class="card shadow-sm" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 16px; width: auto;">
          <div class="card-body p-4">
              <div class="mb-2" style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <h5 class="mb-0"><%= link_to friend.name, friend_path(friend), class: "text-decoration-none" %></h5>
                  <p class="text-muted small mb-0">@<%= friend.username %></p>
                  <p class="text-muted small mb-0"><%= friend.reviews.count %> reviews</p>
                  <% if current_user.following?(friend) %>
                    <%= button_to "Following", unfollow_friend_path(friend), method: :delete, class: "btn btn-sm btn-outline-secondary", title: "Unfollow", form: { style: "display: inline-block; margin: 0;" } %>
                  <% else %>
                    <%= button_to "Follow", follow_friend_path(friend), method: :post, class: "btn btn-sm btn-primary", title: "Follow", form: { style: "display: inline-block; margin: 0;" } %>
                  <% end %>
                </div>
              </div>

              <% friend_reviews = friend.reviews.order(created_at: :desc).limit(2) %>
              <% if friend_reviews.any? %>
                <div class="review-preview mt-3 pt-3 border-top">
                  <h6 class="text-muted mb-3">Recent Reviews</h6>
                  <% friend_reviews.each do |review| %>
                    <div class="mb-3 <%= 'pb-3 border-bottom' unless review == friend_reviews.last %>">
                      <div class="d-flex justify-content-between align-items-start mb-1">
                        <div class="flex-grow-1">
                          <p class="mb-0 fw-bold"><%= review.song.title %></p>
                          <p class="mb-0 small text-muted"><%= review.song.artist %></p>
                        </div>
                        <span class="small text-warning ms-2 flex-shrink-0">⭐ <%= review.rating %>/5</span>
                      </div>
                      <p class="small text-muted mb-0 mt-1"><%= truncate(review.comment, length: 100) %></p>
                    </div>
                  <% end %>
                  <%= link_to "View all reviews →", friend_path(friend), class: "small text-primary text-decoration-none mt-2 d-inline-block" %>
                </div>
              <% else %>
                <div class="mt-3 pt-3 border-top">
                  <p class="small text-muted mb-0">No reviews yet</p>
                </div>
              <% end %>
            </div>
          </div>
      <% end %>
    </div>
  <% elsif @query.present? %>
    <div class="alert alert-info">
      No users found matching "<%= @query %>". Try searching for other usernames or names.
    </div>
  <% else %>
    <div class="alert alert-info">
      Start searching to find and follow other music enthusiasts!
    </div>
  <% end %>
</div>

