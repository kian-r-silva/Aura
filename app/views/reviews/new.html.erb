<h1>New Review</h1>

<%= form_with model: @review, url: reviews_path do |f| %>
  <%# Hidden fields to carry album/track info from Spotify or manual MusicBrainz selection %>
    <%# Prefer @song attributes when present, fall back to params (this ensures reviews opened for local songs show correctly) %>
    <%= hidden_field_tag :song_id, params[:song_id].presence || (@song&.id), id: 'song_id' %>
    <%= hidden_field_tag :album_title, (@song&.album.presence || params[:album_title]), id: 'album_title' %>
    <%= hidden_field_tag :artists, (@song&.artist.presence || params[:artists]), id: 'artists' %>
    <%= hidden_field_tag :track_id, (params[:track_id].presence || params[:track_name].presence), id: 'track_id' %>
    <%= hidden_field_tag :track_name, (@song&.title.presence || params[:track_name]), id: 'track_name' %>

  <%# Show selected track summary when params are present (Spotify or MusicBrainz Review button) %>
  <% if @song.present? || params[:track_name].present? || params[:track_id].present? || params[:song_id].present? %>
    <div class="selected-track" style="border:1px solid #e5e7eb;padding:12px;margin-bottom:12px;border-radius:6px;">
      <strong>Selected track</strong>
      <div style="margin-top:8px">
        <div><strong>Track:</strong> <%= (@song&.title.presence || params[:track_name].presence || '—') %></div>
        <div><strong>Artist(s):</strong> <%= (@song&.artist.presence || params[:artists].presence || '—') %></div>
        <div><strong>Album:</strong> <%= (@song&.album.presence || params[:album_title].presence || '—') %></div>
      </div>
    </div>
  <% end %>

  <div>
    <%= f.label :rating %>
    <%= f.number_field :rating, in: 1..5 %>
  </div>

  <div>
    <%= f.label :comment %>
    <%= f.text_area :comment, rows: 6 %>
  </div>

  <div>
    <%= f.submit 'Submit review' %>
  </div>
<% end %>
