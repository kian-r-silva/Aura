<% if current_user %>

  <% if current_user && current_user.lastfm_connected? %>
    <div class="lastfm-search" style="margin-bottom:18px;">
      <%= form_with url: lastfm_search_path, method: :get, local: true do |f| %>
        <div style="display:flex; gap:8px; align-items:center;">
          <%= f.text_field :q, placeholder: 'Search Last.fm — song or artist', value: params[:q], size: 40, class: 'input' %>
          <%= f.submit 'Search & Review', class: 'btn btn-primary' %>
        </div>
      <% end %>
    </div>
    <div class="cta-recent" style="padding:12px; margin-bottom:16px;">
      <h3>Review songs you recently scrobbled</h3>
      <p>Pick a few of the tracks you listened to recently and add your thoughts.</p>
      <%= link_to "Review recently played", lastfm_recent_path, class: "btn btn-primary" %>
    </div>
  <% end %>

<div class="recommendations" style="margin-top:24px;">
    <h3>Recommendations for you</h3>
    <p>Based on your listening, we think you might enjoy these. Give these a listen and drop a review!</p>
    <% if @recommendations.present? %>
      <ol>
        <% @recommendations.each do |item| %>
          <% if item.is_a?(Song) || item.respond_to?(:title) %>
            <% s = item %>
            <% avg = (s.respond_to?(:avg_rating) && s.avg_rating) || s.average_rating %>
            <li style="display:flex;align-items:center;gap:8px;">
              <div style="flex:1"><%= link_to s.title, song_path(s) %> — <%= s.artist %> (<%= avg || '—' %>)</div>
              <div>
                <%= link_to 'Review', new_review_path(song_id: s.id), class: 'btn btn-sm' %>
              </div>
            </li>
          <% elsif item.is_a?(Hash) && item[:name].present? %>
            <li style="display:flex;align-items:center;gap:8px;">
              <div style="flex:1">
                <% if item[:url].present? %>
                  <a href="<%= item[:url] %>" target="_blank" rel="noopener noreferrer"><%= item[:name] %></a>
                <% else %>
                  <%= item[:name] %>
                <% end %>
                 — <%= item[:artist] %>
              </div>
              <div>
                <%= link_to 'Review', new_review_path(track_name: item[:name], artists: item[:artist], album_title: nil), class: 'btn btn-sm' %>
              </div>
            </li>
          <% end %>
        <% end %>
      </ol>
    <% else %>
      <p>No recommendations yet. Connect Last.fm or review songs to get suggestions.</p>
    <% end %>
  </div>

  <div class="manual-search" style="margin-top:18px;">
    <h3>Add a song manually</h3>
    <p>If you do not have Spotify connected, search MusicBrainz and add a review manually.</p>
    <div data-controller="musicbrainz-autocomplete">
      <div style="display:flex;gap:8px;align-items:center;">
   <input aria-label="Song title" placeholder="Song title" data-musicbrainz-autocomplete-target="titleInput"
     data-action="keydown->musicbrainz-autocomplete#search" />
   <input aria-label="Artist" placeholder="Artist" data-musicbrainz-autocomplete-target="artistInput"
     data-action="keydown->musicbrainz-autocomplete#search" />
   <button type="button" class="btn btn-secondary" data-action="click->musicbrainz-autocomplete#search">Search</button>
      </div>
      <ul data-musicbrainz-autocomplete-target="list" style="margin-top:0.5rem"></ul>
    </div>

  </div>

<% else %>
  <div class="text-center">
    <h2>Welcome to Aura</h2>
    <p>Where Music Taste Comes to Life</p>
    <p>You must <%= link_to "sign in", new_session_path %> or <%= link_to "sign up", new_user_path %> to review and search songs.</p>
  </div>
<% end %>
